PARTITIONS=vtbd0
DISTRIBUTIONS="kernel.txz base.txz"

#!/bin/sh
echo "==> Running installerconfig"

# Enable serial and internal consoles
echo "==> Enabling serial and internal consoles"
echo "-Dh" > /boot.config
echo "cuaa0   "/usr/libexec/getty std.38400"  xterm   on  secure" >> /etc/ttys
echo ""

# Setup /etc/rc.conf
echo "==> Setting up networking"
cat > /etc/rc.conf << RC_CONF
fsck_y_enable="YES"
dumpdev="AUTO"

ifconfig_em0="DHCP"
ifconfig_vtnet0="DHCP"

sshd_enable="YES"
ntpd_enable="YES"
ntpd_sync_on_start="YES"

RC_CONF
echo ""
sleep 10

echo "==> Contents of /etc/resolv.conf"
cat /etc/resolv.conf
echo ""
sleep 10

echo "==> Starting netif"
service netif start
echo ""
sleep 10

echo "==> Getting output of ifconfig"
ifconfig -a
echo ""
sleep 10

echo "==> Restarting netif"
service netif restart
echo ""
sleep 10

echo "==> Testing host lookup of pkg.FreeBSD.org"
host pkg.FreeBSD.org
echo ""
sleep 10

# Set Time Zone to UTC
echo "==> Setting Time Zone to UTC"
/bin/cp /usr/share/zoneinfo/UTC /etc/localtime
/usr/bin/touch /etc/wall_cmos_clock
/sbin/adjkerntz -a
echo ""
sleep 10

# Install packages
echo "==> Bootstrapping pkg"
env ASSUME_ALWAYS_YES=YES pkg bootstrap
echo ""
sleep 10

echo "==> Installing packages"
env ASSUME_ALWAYS_YES=YES pkg install -y bash curl node npm ntp vim-lite wget
echo ""
sleep 10

# Install me-freebsd
echo "==> Contents of /usr/freebsd-dist/:"
ls /usr/freebsd-dist/
echo ""
cp -R /usr/freebsd-dist/me-freebsd/ /

## Build date used for motd and product file
BUILDDATE=$(date +%Y%m%d)
RELEASE="10.0"
DOC_URL="http://wiki.joyent.com/jpc2/Freebsd"

# Create MOTD
echo "Creating /etc/motd"
mv /etc/motd /etc/motd-backup
cat << MOTD > /etc/motd
   __        .                   .
 _|  |_      | .-. .  . .-. :--. |-
|_    _|     ;|   ||  |(.-' |  | |
  |__|   \`--'  \`-' \`;-| \`-' '  ' \`-'
                   /  ;  Instance (FreeBSD $RELEASE $BUILDDATE)
                   \`-'   $DOC_URL

MOTD

# Create product file
echo "Creating /etc/product file"
cat << PRODUCT > /etc/product
Name: Joyent Instance
Image: FreeBSD $RELEASE $BUILDDATE
Documentation: $DOC_URL
Description: FreeBSD $RELEASE 64-bit image with just essential packages \
installed. Ideal for users who are comfortable with setting up their \
own environment and tools.
PRODUCT

echo "End of installerconfig"
sleep 10

# Shutdown/Poweroff
poweroff
